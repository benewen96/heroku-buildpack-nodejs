#!/usr/bin/env bash
# See README.md for info on running these tests.

testDetectWithPackageJson() {
  detect "stable-node"
  assertCaptured "Node.js"
  assertCapturedSuccess
}

testDetectWithoutPackageJson() {
  detect "no-package-json"
  assertCapturedError 1 ""
}

testNoVersion() {
  compile "no-version"
  assertCaptured "PRO TIP: You should specify a node version in package.json"
  assertCaptured "Node version not specified in package.json"
  assertCaptured "Resolving node version (latest stable) with semver.io"
  assertCaptured "Downloading and installing node 0.10"
  assertCapturedSuccess
}

testDangerousRangeStar() {
  compile "dangerous-range-star"
  assertCaptured "PRO TIP: Avoid using semver ranges like '*'"
  assertCaptured "Node version * in package.json"
  assertCaptured "Resolving node version * with semver.io"
  assertCaptured "Downloading and installing node 0.10"
  assertCapturedSuccess
}

testDangerousRangeGreaterThan() {
  compile "dangerous-range-greater-than"
  assertCaptured "PRO TIP: Avoid using semver ranges starting with '>'"
  assertCaptured "Resolving node version >0.4 with semver.io"
  assertCaptured "Downloading and installing node 0.10"
  assertCapturedSuccess
}

testRangeWithSpace() {
  compile "range-with-space"
  assertCaptured "Resolving node version >= 0.8.x with semver.io"
  assertCaptured "Downloading and installing node 0.10"
  assertCapturedSuccess
}

testStableVersion() {
  compile "stable-node"
  assertNotCaptured "PRO TIP:"
  assertCaptured "Downloading and installing node 0.10"
  assertCapturedSuccess
}

testUnstableVersion() {
  compile "unstable-version"
  assertCaptured "Resolving node version >0.11.0 with semver.io"
  assertCaptured "Downloading and installing node 0.11"
  assertCapturedSuccess
}

testProfileCreated() {
  compile "stable-node"
  assertCaptured "Building runtime environment"
  assertFile $'export PATH="$HOME/.heroku/node/bin:$HOME/bin:$HOME/node_modules/.bin:$PATH\";\nnpm_config_production=true' ".profile.d/nodejs.sh"
  assertCapturedSuccess
}

testInvalidDependency() {
  compile "invalid-dependency"
  assertCaptured "not in the npm registry"
  assertCapturedError 1 ""
}

testNodeModulesCached() {
  cache=$(mktmpdir)
  compile "caching" $cache
  assertCaptured "Caching node_modules for future builds"
  assertEquals "1" "$(ls -1 $cache/ | wc -l)"
}

testBuildWithCache() {
  cache=$(mktmpdir)
  compile "stable-node" $cache
  assertCaptured "No cached node_modules are present"
  assertCaptured "Caching node_modules for future builds"
  assertCapturedSuccess
  compile "stable-node" $cache
  assertCaptured "Cache of node_modules is present"
  assertCaptured "Restoring node_modules from cache"
  assertCapturedSuccess
}

testModulesCheckedIn() {
  compile "modules-checked-in"
  assertCaptured "Found existing node_modules directory; skipping cache and installation"
  assertCaptured "Rebuilding any native dependencies"
  assertCapturedSuccess
}

testUserConfig() {
  compile "userconfig"
  assertCaptured "www.google.com"
  assertCaptured "registry error"
  assertCapturedError 1 ""
}

testProcfileAbsentNpmStartPresent() {
  compile "procfile-absent-npm-start-present"
  assertCaptured "App will start via npm start."
  assertCaptured "No Procfile found; Adding 'web: npm start' to new Procfile"
  assertFile "web: npm start" "Procfile"
  assertCapturedSuccess
}

testProcfileAbsentNpmStartAbsent() {
  compile "procfile-absent-npm-start-absent"
  assertCaptured "App will be un-startable (no Procfile, package.json start script, or server.js provided)"
  assertNotCaptured "new Procfile"
  assertCapturedSuccess
}

testProcfileAbsentServerPresent() {
  compile "procfile-absent-server-present"
  assertCaptured "App will start via server.js."
  assertCaptured "No Procfile found; Adding 'web: npm start' to new Procfile"
  assertFile "web: npm start" "Procfile"
  assertCapturedSuccess
}

testEnvVars() {
  env_dir=$(mktmpdir)
  echo "false" > $env_dir/npm_config_production
  compile "stable-node" "$(mktmpdir)" $env_dir
  assertCaptured "npm_config_production=false"
  assertCapturedSuccess
}

testNoEnvVars() {
  env_dir=$(mktmpdir)
  compile "stable-node" "$(mktmpdir)" $env_dir
  assertCaptured "npm_config_production=true"
  assertCapturedSuccess
}

testNoDevDependencies() {
  compile "dev-dependencies"
  assertNotCaptured "lodash"
  assertCapturedSuccess
}

testDevDependencies() {
  env_dir=$(mktmpdir)
  echo "false" > $env_dir/npm_config_production
  compile "dev-dependencies" "$(mktmpdir)" $env_dir
  assertCaptured "lodash"
  assertCapturedSuccess
}

testNpmUpdate() {
  cache=$(mktmpdir)
  compile "npm-update-1" $cache
  assertCaptured "lodash@1.0.0"
  assertCapturedSuccess
  compile "npm-update-1" $cache
  assertCaptured "lodash@1.0.0"
  assertCapturedSuccess
  compile "npm-update-2" $cache
  assertCaptured "lodash@1.3.1"
  assertCapturedSuccess
}

# Utils

pushd $(dirname 0) >/dev/null
bp_dir=$(pwd)
popd >/dev/null

source ${bp_dir}/vendor/test-utils/test-utils

mktmpdir() {
  dir=$(mktemp -t testXXXXX)
  rm -rf $dir
  mkdir $dir
  echo $dir
}

detect() {
  capture ${bp_dir}/bin/detect ${bp_dir}/test/$1
}

compile_dir=""

compile() {
  compile_dir=$(mktmpdir)
  cp -r ${bp_dir}/test/$1/. ${compile_dir}
  capture ${bp_dir}/bin/compile ${compile_dir} ${2:-$(mktmpdir)} $3
}

assertFile() {
  assertEquals "$1" "$(cat ${compile_dir}/$2)"
}

source ${bp_dir}/vendor/shunit2/shunit2
